<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Expense Manager Pro</title>

    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js with fallback -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --primary-light: #a3bffa;
            --secondary: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --info: #4299e1;
            --dark: #2d3748;
            --gray-100: #f7fafc;
            --gray-200: #edf2f7;
            --gray-300: #e2e8f0;
            --gray-400: #cbd5e0;
            --gray-500: #a0aec0;
            --gray-600: #718096;
            --gray-700: #4a5568;
            --gray-800: #2d3748;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--dark);
            min-height: 100vh;
            padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 15px;
            color: var(--gray-600);
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mini loader for actions */
        .action-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 9998;
            display: none;
            align-items: center;
            gap: 15px;
        }

        .action-loading.show {
            display: flex;
        }

        .action-loading .mini-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .header-logo {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            object-fit: contain;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        @media (max-width: 480px) {
            .header-logo {
                width: 28px;
                height: 28px;
            }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .icon-btn:hover, .icon-btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Filter Info Banner - NEW */
        .filter-info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: var(--radius-sm);
            padding: 10px 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .filter-info-text {
            color: var(--gray-600);
        }

        .filter-info-count {
            font-weight: 600;
            color: var(--primary);
        }

        /* Summary Cards - Now Clickable */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            touch-action: manipulation;
        }

        .summary-card:active {
            transform: scale(0.98);
        }

        .summary-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .summary-card.income::before { background: var(--secondary); }
        .summary-card.expense::before { background: var(--danger); }
        .summary-card.balance::before { background: var(--primary); }
        .summary-card.pending::before { background: var(--warning); }

        .summary-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
        }

        .summary-card.income .summary-icon { background: rgba(72, 187, 120, 0.1); color: var(--secondary); }
        .summary-card.expense .summary-icon { background: rgba(245, 101, 101, 0.1); color: var(--danger); }
        .summary-card.balance .summary-icon { background: rgba(102, 126, 234, 0.1); color: var(--primary); }
        .summary-card.pending .summary-icon { background: rgba(237, 137, 54, 0.1); color: var(--warning); }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        .summary-card .tap-hint {
            font-size: 0.7rem;
            color: var(--gray-400);
            margin-top: 5px;
        }

        /* Filter Section */
        .filter-section {
            background: var(--white);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none;
        }

        .filter-tabs::-webkit-scrollbar {
            display: none;
        }

        .filter-tab {
            padding: 10px 20px;
            border: none;
            background: var(--gray-200);
            color: var(--gray-600);
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .filter-tab.active, .filter-tab:hover {
            background: var(--primary);
            color: var(--white);
        }

        .date-range-picker {
            display: none;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .date-range-picker.show {
            display: flex;
        }

        .date-input-group {
            flex: 1;
            min-width: 120px;
        }

        .date-input-group label {
            display: block;
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .date-input-group input {
            font-size: 0.85rem;
            padding: 10px 8px;
        }

        /* Form Elements */
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-family: inherit;
            transition: var(--transition);
            background: var(--white);
            -webkit-appearance: none;
            appearance: none;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled), .btn-primary:active:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--secondary);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        /* Expense List */
        .expense-list {
            list-style: none;
        }

        .expense-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--white);
            border-radius: var(--radius);
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            touch-action: manipulation;
        }

        .expense-item:active {
            transform: scale(0.98);
        }

        .expense-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .expense-details {
            flex: 1;
            min-width: 0;
        }

        .expense-title {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .expense-meta {
            font-size: 0.75rem;
            color: var(--gray-500);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .expense-meta span {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .expense-meta .material-icons {
            font-size: 12px;
        }

        .expense-amount {
            font-weight: 700;
            font-size: 1rem;
            text-align: right;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .expense-amount.income {
            color: var(--secondary);
        }

        .expense-amount.expense {
            color: var(--danger);
        }

        .expense-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .expense-actions .icon-btn {
            background: var(--gray-100);
            color: var(--gray-600);
            width: 35px;
            height: 35px;
        }

        .expense-actions .icon-btn:hover {
            background: var(--gray-200);
        }

        .expense-actions .icon-btn.delete:hover {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        /* Category Colors */
        .cat-food { background: rgba(237, 137, 54, 0.1); color: var(--warning); }
        .cat-transport { background: rgba(66, 153, 225, 0.1); color: var(--info); }
        .cat-shopping { background: rgba(159, 122, 234, 0.1); color: #9f7aea; }
        .cat-entertainment { background: rgba(237, 100, 166, 0.1); color: #ed64a6; }
        .cat-bills { background: rgba(245, 101, 101, 0.1); color: var(--danger); }
        .cat-health { background: rgba(72, 187, 120, 0.1); color: var(--secondary); }
        .cat-education { background: rgba(56, 178, 172, 0.1); color: #38b2ac; }
        .cat-other { background: rgba(113, 128, 150, 0.1); color: var(--gray-600); }
        .cat-salary { background: rgba(72, 187, 120, 0.1); color: var(--secondary); }
        .cat-freelance { background: rgba(102, 126, 234, 0.1); color: var(--primary); }
        .cat-investment { background: rgba(237, 137, 54, 0.1); color: var(--warning); }
        .cat-gift { background: rgba(237, 100, 166, 0.1); color: #ed64a6; }
        .cat-family { background: rgba(245, 101, 101, 0.1); color: var(--danger); }
        .cat-refund { background: rgba(56, 178, 172, 0.1); color: #38b2ac; }
        .cat-income-other { background: rgba(113, 128, 150, 0.1); color: var(--gray-600); }
        .cat-business { background: rgba(159, 122, 234, 0.1); color: #9f7aea; }

        /* Friends/Profiles Section */
        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .friend-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            touch-action: manipulation;
            position: relative;
        }

        .friend-card:active {
            transform: scale(0.98);
        }

        .friend-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: 600;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .friend-info {
            flex: 1;
        }

        .friend-info h3 {
            font-size: 1.1rem;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .friend-info p {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        /* Pending split indicator for friend card */
        .friend-split-indicator {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: rgba(237, 137, 54, 0.15);
            color: var(--warning);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .friend-split-indicator .material-icons {
            font-size: 12px;
        }

        .friend-balance {
            text-align: center;
            padding: 15px;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
        }

        .friend-balance .amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .friend-balance .amount.positive {
            color: var(--secondary);
        }

        .friend-balance .amount.negative {
            color: var(--danger);
        }

        .friend-balance .label {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-top: 5px;
        }

        .friend-actions {
            display: flex;
            gap: 10px;
        }

        .friend-actions .btn {
            flex: 1;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 8px 10px 12px;
            z-index: 100;
            height: 70px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 8px;
            color: var(--gray-500);
            text-decoration: none;
            font-size: 0.7rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            background: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            flex: 1;
            min-width: 0;
            height: 50px;
        }

        .nav-item .material-icons {
            font-size: 1.4rem;
            margin-bottom: 3px;
        }

        .nav-item.active, .nav-item:hover {
            color: var(--primary);
        }

        .nav-item.add-btn {
            position: relative;
            top: -15px;
            background: var(--primary);
            color: var(--white);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            box-shadow: var(--shadow-lg);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 56px;
            min-width: 56px;
            max-width: 56px;
        }

        .nav-item.add-btn:hover, .nav-item.add-btn:active {
            background: var(--primary-dark);
            color: var(--white);
            transform: scale(1.1);
        }

        .nav-item.add-btn .material-icons {
            font-size: 1.8rem;
            margin: 0;
        }

        .nav-item.add-btn span:last-child {
            display: none;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: flex-end;
            z-index: 200;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: var(--radius) var(--radius) 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            padding: 5px;
            touch-action: manipulation;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 10px;
        }

        /* Category Selector */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .category-option {
            padding: 12px 8px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            touch-action: manipulation;
        }

        .category-option:hover {
            border-color: var(--primary-light);
        }

        .category-option.selected {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .category-option .material-icons {
            font-size: 1.3rem;
            margin-bottom: 4px;
            display: block;
        }

        .category-option span {
            font-size: 0.65rem;
            display: block;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
            padding: 4px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            border-radius: 6px;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .tab.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: var(--shadow);
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 250px;
            margin: 20px 0;
        }

        .chart-fallback {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray-500);
            text-align: center;
        }

        .chart-fallback .material-icons {
            font-size: 3rem;
            margin-bottom: 10px;
            color: var(--gray-300);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-500);
        }

        .empty-state .material-icons {
            font-size: 4rem;
            color: var(--gray-300);
            margin-bottom: 15px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--gray-600);
        }

        /* Split Transaction */
        .split-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
        }

        .split-item select {
            flex: 1.5;
        }

        .split-item input {
            flex: 1;
        }

        .split-item .icon-btn {
            background: var(--danger);
            color: var(--white);
            flex-shrink: 0;
        }

        .split-warning {
            background: rgba(237, 137, 54, 0.1);
            border: 1px solid rgba(237, 137, 54, 0.3);
            color: var(--warning);
            padding: 10px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            margin-top: 10px;
            display: none;
        }

        .split-warning.show {
            display: block;
        }

        /* Transaction History - Improved Layout */
        .transaction-history {
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .history-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border-bottom: 1px solid var(--gray-200);
            gap: 10px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item-info {
            flex: 1;
            min-width: 0;
        }

        .history-item-title {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .history-item-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .history-item-date {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .history-item-amount {
            flex-shrink: 0;
        }

        .history-item-actions {
            flex-shrink: 0;
        }

        /* Fixed delete button visibility */
        .history-item-actions .icon-btn {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
            width: 32px;
            height: 32px;
        }

        .history-item-actions .icon-btn:hover {
            background: rgba(245, 101, 101, 0.2);
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--gray-300);
            border-radius: 13px;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
            touch-action: manipulation;
        }

        .toggle.active {
            background: var(--primary);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: var(--white);
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle.active::after {
            left: 27px;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .modal {
                border-radius: var(--radius);
                max-height: 80vh;
            }

            .modal-overlay {
                align-items: center;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .category-option {
                padding: 10px 5px;
            }

            .category-option .material-icons {
                font-size: 1.2rem;
            }
        }

        /* Page sections */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Date Group */
        .date-group {
            margin-bottom: 20px;
        }

        .date-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-500);
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .date-total {
            font-weight: 700;
            color: var(--danger);
        }

        .date-total.positive {
            color: var(--secondary);
        }

        /* Settle Up Summary */
        .settle-summary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 15px;
        }

        .settle-summary h3 {
            margin-bottom: 5px;
        }

        .settle-summary p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* Badge */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }

        .badge-success {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .badge-danger {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        .badge-warning {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .badge-info {
            background: rgba(66, 153, 225, 0.1);
            color: var(--info);
        }

        .badge .material-icons {
            font-size: 12px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark);
            color: var(--white);
            padding: 15px 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 300;
            opacity: 0;
            transition: var(--transition);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Search Bar */
        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-bar input {
            padding-left: 45px;
        }

        .search-bar .material-icons {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--gray-500);
        }

        /* Split pending badge */
        .split-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        /* Pending splits section */
        .pending-splits {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-200);
        }

        .pending-splits h4 {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-bottom: 10px;
        }

        .pending-split-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(237, 137, 54, 0.05);
            border: 1px solid rgba(237, 137, 54, 0.2);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .pending-split-info {
            flex: 1;
        }

        .pending-split-desc {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .pending-split-date {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .pending-split-amount {
            font-weight: 600;
            color: var(--warning);
            margin-right: 10px;
        }

        /* Confirm Dialog */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 250;
            padding: 20px;
        }

        .confirm-dialog.show {
            display: flex;
        }

        .confirm-content {
            background: var(--white);
            border-radius: var(--radius);
            padding: 25px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            animation: scaleIn 0.2s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .confirm-content h3 {
            margin-bottom: 15px;
        }

        .confirm-content p {
            color: var(--gray-600);
            margin-bottom: 20px;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Edit button in friend detail */
        .edit-friend-btn {
            position: absolute;
            right: 50px;
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            padding: 5px;
            touch-action: manipulation;
        }

        .modal-header {
            position: relative;
        }

        /* Transaction Detail Modal */
        .transaction-detail {
            padding: 20px;
        }

        .transaction-detail-header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 20px;
        }

        .transaction-detail-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2rem;
        }

        .transaction-detail-amount {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .transaction-detail-amount.income { color: var(--secondary); }
        .transaction-detail-amount.expense { color: var(--danger); }

        .transaction-detail-desc {
            font-size: 1.1rem;
            color: var(--gray-700);
        }

        .transaction-detail-info {
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--gray-500);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-label .material-icons {
            font-size: 18px;
        }

        .detail-value {
            font-weight: 500;
            text-align: right;
        }

        .transaction-detail-actions {
            display: flex;
            gap: 10px;
        }

        .transaction-detail-actions .btn {
            flex: 1;
        }

        /* Summary Modal Styles */
        .summary-detail-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .summary-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: var(--transition);
        }

        .summary-detail-item:hover {
            background: var(--gray-100);
        }

        .summary-detail-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading...</div>
</div>

<!-- Action Loading -->
<div class="action-loading" id="actionLoading">
    <div class="mini-spinner"></div>
    <span>Please wait...</span>
</div>

<!-- Header -->
<header class="header">
    <div class="header-content">
        <h1>
            <div class="header-logo">ðŸ’°</div>
            Expense Manager
        </h1>
        <div class="header-actions">
            <button class="icon-btn" id="settingsBtn" title="Settings" aria-label="Settings">
                <span class="material-icons">settings</span>
            </button>
        </div>
    </div>
</header>

<!-- Main Container -->
<main class="container">
    <!-- Dashboard Page -->
    <section id="dashboardPage" class="page active">
        <!-- Summary Cards -->
        <div class="summary-grid">
            <div class="summary-card income" id="incomeCard" data-type="income">
                <div class="summary-icon">
                    <span class="material-icons">trending_up</span>
                </div>
                <div class="summary-value" id="totalIncome">â‚¹0</div>
                <div class="summary-label">Income</div>
                <div class="tap-hint">Tap to view</div>
            </div>
            <div class="summary-card expense" id="expenseCard" data-type="expense">
                <div class="summary-icon">
                    <span class="material-icons">trending_down</span>
                </div>
                <div class="summary-value" id="totalExpense">â‚¹0</div>
                <div class="summary-label">Expenses</div>
                <div class="tap-hint">Tap to view</div>
            </div>
            <div class="summary-card balance" id="balanceCard" data-type="balance">
                <div class="summary-icon">
                    <span class="material-icons">account_balance</span>
                </div>
                <div class="summary-value" id="totalBalance">â‚¹0</div>
                <div class="summary-label">Balance</div>
                <div class="tap-hint">Tap to view</div>
            </div>
            <div class="summary-card pending" id="pendingCard" data-type="pending">
                <div class="summary-icon">
                    <span class="material-icons">pending</span>
                </div>
                <div class="summary-value" id="pendingAmount">â‚¹0</div>
                <div class="summary-label">Pending</div>
                <div class="tap-hint">Tap to view</div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-tabs" id="dashboardFilterTabs">
                <button class="filter-tab" data-filter="today">Today</button>
                <button class="filter-tab" data-filter="week">This Week</button>
                <button class="filter-tab active" data-filter="month">This Month</button>
                <button class="filter-tab" data-filter="all">All Time</button>
                <button class="filter-tab" data-filter="custom">Custom</button>
            </div>
            <div class="date-range-picker" id="dateRangePicker">
                <div class="date-input-group">
                    <label>From</label>
                    <input type="date" id="startDate">
                </div>
                <div class="date-input-group">
                    <label>To</label>
                    <input type="date" id="endDate">
                </div>
                <button class="btn btn-primary btn-sm" id="applyDateRangeBtn">
                    Apply
                </button>
            </div>
        </div>

        <!-- Filter Info Banner -->
        <div class="filter-info" id="filterInfo">
            <span class="filter-info-text">Showing transactions for <strong id="filterPeriodText">This Month</strong></span>
            <span class="filter-info-count" id="filterCount">0 transactions</span>
        </div>

        <!-- Chart Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <span class="material-icons">pie_chart</span>
                    Expense Breakdown
                </h3>
            </div>
            <div class="chart-container" id="expenseChartContainer">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <span class="material-icons">receipt_long</span>
                    Recent Transactions
                </h3>
                <button class="btn btn-sm btn-secondary" id="viewAllTransactionsBtn">
                    View All
                </button>
            </div>
            <ul class="expense-list" id="recentTransactions">
                <!-- Transactions will be loaded here -->
            </ul>
        </div>
    </section>

    <!-- Transactions Page -->
    <section id="transactionsPage" class="page">
        <!-- Search -->
        <div class="search-bar">
            <span class="material-icons">search</span>
            <input type="text" id="searchTransactions" placeholder="Search transactions...">
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-tabs" id="transactionsFilterTabs">
                <button class="filter-tab" data-filter="today">Today</button>
                <button class="filter-tab" data-filter="week">This Week</button>
                <button class="filter-tab active" data-filter="month">This Month</button>
                <button class="filter-tab" data-filter="all">All</button>
            </div>
        </div>

        <!-- Transactions List -->
        <div id="transactionsList">
            <!-- Grouped transactions will be loaded here -->
        </div>
    </section>

    <!-- Stats Page -->
    <section id="statsPage" class="page">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="statTotalTransactions">0</div>
                <div class="stat-label">Transactions</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statAvgExpense">â‚¹0</div>
                <div class="stat-label">Avg/Day</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statTopCategory">-</div>
                <div class="stat-label">Top Category</div>
            </div>
        </div>

        <!-- Monthly Chart -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <span class="material-icons">bar_chart</span>
                    Monthly Overview
                </h3>
            </div>
            <div class="chart-container" id="monthlyChartContainer">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>

        <!-- Category Chart -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <span class="material-icons">donut_large</span>
                    Category Breakdown
                </h3>
            </div>
            <div class="chart-container" id="categoryChartContainer">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </section>

    <!-- Friends Page -->
    <section id="friendsPage" class="page">
        <div class="settle-summary" id="settleSummary">
            <h3>Net Balance</h3>
            <p>You'll see your overall balance with friends here</p>
        </div>

        <!-- Search Friends -->
        <div class="search-bar">
            <span class="material-icons">search</span>
            <input type="text" id="searchFriends" placeholder="Search friends...">
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <span class="material-icons">groups</span>
                    Friends
                </h3>
                <button class="btn btn-sm btn-primary" id="addFriendBtn">
                    <span class="material-icons">person_add</span>
                    Add
                </button>
            </div>
            <div class="friends-grid" id="friendsList">
                <!-- Friends will be loaded here -->
            </div>
        </div>
    </section>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <button class="nav-item active" data-page="dashboardPage" aria-label="Home">
        <span class="material-icons">dashboard</span>
        <span>Home</span>
    </button>
    <button class="nav-item" data-page="transactionsPage" aria-label="Transactions">
        <span class="material-icons">receipt_long</span>
        <span>Transactions</span>
    </button>
    <button class="nav-item add-btn" id="addExpenseBtn" aria-label="Add Transaction">
        <span class="material-icons">add</span>
        <span></span>
    </button>
    <button class="nav-item" data-page="statsPage" aria-label="Statistics">
        <span class="material-icons">analytics</span>
        <span>Stats</span>
    </button>
    <button class="nav-item" data-page="friendsPage" aria-label="Friends">
        <span class="material-icons">groups</span>
        <span>Friends</span>
    </button>
</nav>

<!-- Transaction Detail Modal -->
<div class="modal-overlay" id="transactionDetailModal">
    <div class="modal">
        <div class="modal-header">
            <h2>
                <span class="material-icons">receipt</span>
                Transaction Details
            </h2>
            <button class="modal-close" id="closeTransactionDetailModal" aria-label="Close">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body transaction-detail" id="transactionDetailContent">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<!-- Summary Detail Modal -->
<div class="modal-overlay" id="summaryDetailModal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="summaryDetailTitle">
                <span class="material-icons">info</span>
                Details
            </h2>
            <button class="modal-close" id="closeSummaryDetailModal" aria-label="Close">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="summary-detail-list" id="summaryDetailList">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary btn-block" id="summaryDetailCloseBtn">Close</button>
        </div>
    </div>
</div>

<!-- Add Expense Modal -->
<div class="modal-overlay" id="addExpenseModal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="expenseModalTitle">
                <span class="material-icons">add_circle</span>
                Add Transaction
            </h2>
            <button class="modal-close" id="closeExpenseModal" aria-label="Close">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body">
            <!-- Transaction Type Tabs -->
            <div class="tabs" id="transactionTypeTabs">
                <button class="tab active" data-type="expense">
                    Expense
                </button>
                <button class="tab" data-type="income">
                    Income
                </button>
            </div>

            <form id="expenseForm">
                <input type="hidden" id="transactionId">
                <input type="hidden" id="transactionType" value="expense">

                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="amount" placeholder="Enter amount" required step="0.01" min="0" inputmode="decimal">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="description" placeholder="What was this for?" required>
                </div>

                <div class="form-group" id="expenseCategorySection">
                    <label>Category</label>
                    <div class="category-grid" id="categoryGrid">
                        <div class="category-option selected" data-category="food">
                            <span class="material-icons">restaurant</span>
                            <span>Food</span>
                        </div>
                        <div class="category-option" data-category="transport">
                            <span class="material-icons">directions_car</span>
                            <span>Transport</span>
                        </div>
                        <div class="category-option" data-category="shopping">
                            <span class="material-icons">shopping_bag</span>
                            <span>Shopping</span>
                        </div>
                        <div class="category-option" data-category="entertainment">
                            <span class="material-icons">movie</span>
                            <span>Fun</span>
                        </div>
                        <div class="category-option" data-category="bills">
                            <span class="material-icons">receipt</span>
                            <span>Bills</span>
                        </div>
                        <div class="category-option" data-category="health">
                            <span class="material-icons">favorite</span>
                            <span>Health</span>
                        </div>
                        <div class="category-option" data-category="education">
                            <span class="material-icons">school</span>
                            <span>Education</span>
                        </div>
                        <div class="category-option" data-category="other">
                            <span class="material-icons">more_horiz</span>
                            <span>Other</span>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="incomeCategorySection" style="display: none;">
                    <label>Source</label>
                    <div class="category-grid" id="incomeCategoryGrid">
                        <div class="category-option selected" data-category="salary">
                            <span class="material-icons">work</span>
                            <span>Salary</span>
                        </div>
                        <div class="category-option" data-category="freelance">
                            <span class="material-icons">laptop</span>
                            <span>Freelance</span>
                        </div>
                        <div class="category-option" data-category="investment">
                            <span class="material-icons">trending_up</span>
                            <span>Investment</span>
                        </div>
                        <div class="category-option" data-category="gift">
                            <span class="material-icons">card_giftcard</span>
                            <span>Gift</span>
                        </div>
                        <div class="category-option" data-category="family">
                            <span class="material-icons">family_restroom</span>
                            <span>Family</span>
                        </div>
                        <div class="category-option" data-category="refund">
                            <span class="material-icons">replay</span>
                            <span>Refund</span>
                        </div>
                        <div class="category-option" data-category="business">
                            <span class="material-icons">business</span>
                            <span>Business</span>
                        </div>
                        <div class="category-option" data-category="income-other">
                            <span class="material-icons">more_horiz</span>
                            <span>Other</span>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="expenseDate">
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="time" id="expenseTime">
                    </div>
                </div>

                <!-- Split Expense Section -->
                <div class="form-group" id="splitSection">
                    <div class="toggle-container" style="margin-bottom: 15px;">
                        <span>Split with friends</span>
                        <div class="toggle" id="splitToggle"></div>
                    </div>
                    <div id="splitDetails" style="display: none;">
                        <div id="splitItems">
                            <!-- Split items will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" id="addSplitItemBtn">
                            <span class="material-icons">add</span>
                            Add Person
                        </button>
                        <div class="split-warning" id="splitWarning">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">warning</span>
                            Split amounts exceed total expense!
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="notes" rows="2" placeholder="Add any notes..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelExpenseBtn">Cancel</button>
            <button class="btn btn-primary" id="saveExpenseBtn">
                <span class="material-icons">save</span>
                Save
            </button>
        </div>
    </div>
</div>

<!-- Add Friend Modal -->
<div class="modal-overlay" id="addFriendModal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="friendModalTitle">
                <span class="material-icons">person_add</span>
                Add Friend
            </h2>
            <button class="modal-close" id="closeFriendModal" aria-label="Close">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body">
            <form id="friendForm">
                <input type="hidden" id="friendId">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="friendName" placeholder="Enter friend's name" required>
                </div>
                <div class="form-group">
                    <label>Phone (Optional)</label>
                    <input type="tel" id="friendPhone" placeholder="Phone number">
                </div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="friendNotes" rows="2" placeholder="Any notes..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelFriendBtn">Cancel</button>
            <button class="btn btn-primary" id="saveFriendBtn">
                <span class="material-icons">save</span>
                Save
            </button>
        </div>
    </div>
</div>

<!-- Friend Detail Modal -->
<div class="modal-overlay" id="friendDetailModal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="friendDetailName">
                <span class="material-icons">person</span>
                Friend Details
            </h2>
            <button class="edit-friend-btn" id="editFriendBtn" title="Edit" aria-label="Edit Friend">
                <span class="material-icons">edit</span>
            </button>
            <button class="modal-close" id="closeFriendDetailModal" aria-label="Close">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="friend-balance" id="friendDetailBalance">
                <div class="amount">â‚¹0</div>
                <div class="label">Balance</div>
            </div>

            <!-- Pending Splits Section -->
            <div class="pending-splits" id="pendingSplitsSection" style="display: none;">
                <h4>Pending Split Expenses</h4>
                <div id="pendingSplitsList"></div>
            </div>

            <div class="tabs" id="friendActionTabs">
                <button class="tab active" data-action="give">I Gave</button>
                <button class="tab" data-action="receive">I Received</button>
                <button class="tab" data-action="history">History</button>
            </div>

            <div id="friendActionGive" class="friend-action-section">
                <div class="form-group">
                    <label>Amount I gave to <span id="friendGiveName"></span></label>
                    <input type="number" id="giveAmount" placeholder="Enter amount" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="giveDescription" placeholder="What for?">
                </div>
                <button class="btn btn-primary btn-block" id="recordGiveBtn">
                    <span class="material-icons">arrow_upward</span>
                    Record Payment
                </button>
            </div>

            <div id="friendActionReceive" class="friend-action-section" style="display: none;">
                <div class="form-group">
                    <label>Amount I received from <span id="friendReceiveName"></span></label>
                    <input type="number" id="receiveAmount" placeholder="Enter amount" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="receiveDescription" placeholder="What for?">
                </div>
                <button class="btn btn-success btn-block" id="recordReceiveBtn">
                    <span class="material-icons">arrow_downward</span>
                    Record Receipt
                </button>
            </div>

            <div id="friendActionHistory" class="friend-action-section" style="display: none;">
                <div class="transaction-history" id="friendTransactionHistory">
                    <!-- History items will be loaded here -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" id="deleteFriendBtn">
                <span class="material-icons">delete</span>
                Delete
            </button>
            <button class="btn btn-secondary" id="settleUpBtn">
                <span class="material-icons">done_all</span>
                Settle Up
            </button>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
    <div class="modal">
        <div class="modal-header">
            <h2>
                <span class="material-icons">settings</span>
                Settings
            </h2>
            <button class="modal-close" id="closeSettingsModal" aria-label="Close">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Currency Symbol</label>
                <select id="currencySymbol">
                    <option value="â‚¹">â‚¹ (Indian Rupee)</option>
                    <option value="$">$ (US Dollar)</option>
                    <option value="â‚¬">â‚¬ (Euro)</option>
                    <option value="Â£">Â£ (Pound)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Monthly Budget</label>
                <input type="number" id="monthlyBudget" placeholder="Set your monthly budget">
            </div>

            <div class="card" style="margin-top: 20px;">
                <h4 style="margin-bottom: 15px;">Data Management</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="exportDataBtn">
                        <span class="material-icons">download</span>
                        Export
                    </button>
                    <button class="btn btn-secondary" id="importDataBtn">
                        <span class="material-icons">upload</span>
                        Import
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                    <button class="btn btn-danger" id="clearAllDataBtn">
                        <span class="material-icons">delete_forever</span>
                        Clear All
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
        </div>
    </div>
</div>

<!-- Confirm Dialog -->
<div class="confirm-dialog" id="confirmDialog">
    <div class="confirm-content">
        <h3 id="confirmTitle">Confirm</h3>
        <p id="confirmMessage">Are you sure?</p>
        <div class="confirm-buttons">
            <button class="btn btn-secondary" id="confirmCancelBtn">Cancel</button>
            <button class="btn btn-primary" id="confirmYesBtn">Yes</button>
        </div>
    </div>
</div>

<!-- Settle Split Dialog -->
<div class="confirm-dialog" id="settleSplitDialog">
    <div class="confirm-content">
        <h3>Settle Split Expense</h3>
        <p id="settleSplitMessage">This payment matches a split expense. Do you want to:</p>
        <div style="margin: 15px 0;">
            <div class="pending-split-item" id="matchingSplitItem"></div>
        </div>
        <div class="confirm-buttons" style="flex-wrap: wrap;">
            <button class="btn btn-secondary btn-sm" id="settleSplitNewBtn">Record as New</button>
            <button class="btn btn-success btn-sm" id="settleSplitYesBtn">Settle This Split</button>
        </div>
    </div>
</div>

<!-- Update Transaction Dialog -->
<div class="confirm-dialog" id="updateTransactionDialog">
    <div class="confirm-content">
        <h3>Update Original Transaction?</h3>
        <p id="updateTransactionMessage"></p>
        <div class="confirm-buttons">
            <button class="btn btn-secondary" id="updateTransactionNoBtn">Keep Original</button>
            <button class="btn btn-primary" id="updateTransactionYesBtn">Update Amount</button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<script>
    // ==================== DATA MANAGEMENT ====================
    const DB_NAME = 'ExpenseManagerDB';
    const STORES = {
        expenses: 'expenses',
        friends: 'friends',
        friendTransactions: 'friendTransactions',
        settings: 'settings'
    };

    let db = null;
    // FIX: Changed default filter from 'today' to 'month' for better UX
    let currentFilter = 'month';
    let currentTransactionsFilter = 'month';
    let currentFriendId = null;
    let currentViewingExpenseId = null;
    let expenseChart = null;
    let monthlyChart = null;
    let categoryChart = null;
    let confirmCallback = null;
    let settleSplitCallback = null;
    let updateTransactionCallback = null;
    let pendingSplitsForFriend = [];
    let allFriendsData = [];
    let isSaving = false; // FIX: Prevent double-clicks
    let searchTimeout = null; // FIX: Debounce search
    let chartsAvailable = typeof Chart !== 'undefined'; // FIX: Check if Chart.js loaded

    // Category icons and colors
    const expenseCategories = {
        food: { icon: 'restaurant', color: '#ed8936', class: 'cat-food', label: 'Food' },
        transport: { icon: 'directions_car', color: '#4299e1', class: 'cat-transport', label: 'Transport' },
        shopping: { icon: 'shopping_bag', color: '#9f7aea', class: 'cat-shopping', label: 'Shopping' },
        entertainment: { icon: 'movie', color: '#ed64a6', class: 'cat-entertainment', label: 'Entertainment' },
        bills: { icon: 'receipt', color: '#f56565', class: 'cat-bills', label: 'Bills' },
        health: { icon: 'favorite', color: '#48bb78', class: 'cat-health', label: 'Health' },
        education: { icon: 'school', color: '#38b2ac', class: 'cat-education', label: 'Education' },
        other: { icon: 'more_horiz', color: '#718096', class: 'cat-other', label: 'Other' }
    };

    const incomeCategories = {
        salary: { icon: 'work', color: '#48bb78', class: 'cat-salary', label: 'Salary' },
        freelance: { icon: 'laptop', color: '#667eea', class: 'cat-freelance', label: 'Freelance' },
        investment: { icon: 'trending_up', color: '#ed8936', class: 'cat-investment', label: 'Investment' },
        gift: { icon: 'card_giftcard', color: '#ed64a6', class: 'cat-gift', label: 'Gift' },
        family: { icon: 'family_restroom', color: '#f56565', class: 'cat-family', label: 'Family' },
        refund: { icon: 'replay', color: '#38b2ac', class: 'cat-refund', label: 'Refund' },
        business: { icon: 'business', color: '#9f7aea', class: 'cat-business', label: 'Business' },
        'income-other': { icon: 'more_horiz', color: '#718096', class: 'cat-income-other', label: 'Other' }
    };

    const allCategories = { ...expenseCategories, ...incomeCategories };

    // Filter period labels
    const filterLabels = {
        'today': 'Today',
        'week': 'This Week',
        'month': 'This Month',
        'all': 'All Time',
        'custom': 'Custom Range'
    };

    // ==================== LOADING FUNCTIONS ====================
    function showLoading() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showActionLoading() {
        document.getElementById('actionLoading').classList.add('show');
    }

    function hideActionLoading() {
        document.getElementById('actionLoading').classList.remove('show');
    }

    // Initialize IndexedDB
    async function initDB() {
        return new Promise((resolve, reject) => {
            // FIX: Check if IndexedDB is supported
            if (!window.indexedDB) {
                reject(new Error('IndexedDB not supported. Try using a regular browser window.'));
                return;
            }

            const request = indexedDB.open(DB_NAME, 2);

            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };

            request.onupgradeneeded = (event) => {
                const database = event.target.result;

                if (!database.objectStoreNames.contains(STORES.expenses)) {
                    const expenseStore = database.createObjectStore(STORES.expenses, { keyPath: 'id' });
                    expenseStore.createIndex('date', 'date', { unique: false });
                    expenseStore.createIndex('category', 'category', { unique: false });
                    expenseStore.createIndex('type', 'type', { unique: false });
                }

                if (!database.objectStoreNames.contains(STORES.friends)) {
                    database.createObjectStore(STORES.friends, { keyPath: 'id' });
                }

                if (!database.objectStoreNames.contains(STORES.friendTransactions)) {
                    const friendTxStore = database.createObjectStore(STORES.friendTransactions, { keyPath: 'id' });
                    friendTxStore.createIndex('friendId', 'friendId', { unique: false });
                }

                if (!database.objectStoreNames.contains(STORES.settings)) {
                    database.createObjectStore(STORES.settings, { keyPath: 'key' });
                }
            };
        });
    }

    // Generic DB operations
    async function dbAdd(storeName, data) {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const request = store.add(data);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function dbPut(storeName, data) {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const request = store.put(data);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function dbGet(storeName, key) {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const request = store.get(key);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function dbGetAll(storeName) {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function dbDelete(storeName, key) {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const request = store.delete(key);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    async function dbClear(storeName) {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const request = store.clear();
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    // ==================== UTILITY FUNCTIONS ====================
    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function formatCurrency(amount) {
        const settings = JSON.parse(localStorage.getItem('settings') || '{}');
        const symbol = settings.currency || 'â‚¹';
        return `${symbol}${Math.abs(amount).toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'Unknown';
        const date = parseDate(dateStr);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        const dateOnly = new Date(date);
        dateOnly.setHours(0, 0, 0, 0);

        if (dateOnly.getTime() === today.getTime()) {
            return 'Today';
        } else if (dateOnly.getTime() === yesterday.getTime()) {
            return 'Yesterday';
        } else {
            return date.toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
            });
        }
    }

    function formatFullDate(dateStr) {
        if (!dateStr) return 'Unknown';
        const date = parseDate(dateStr);
        return date.toLocaleDateString('en-IN', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
    }

    function formatTime(timeStr) {
        if (!timeStr) return '';
        const [hours, minutes] = timeStr.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        return `${hour12}:${minutes} ${ampm}`;
    }

    // FIX: Improved date parsing to handle timezone issues
    function parseDate(dateStr) {
        if (!dateStr) return new Date();

        // Handle "YYYY-MM-DD" format without timezone shift
        if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        return new Date(dateStr);
    }

    // FIX: Compare dates without time component
    function isSameDay(date1, date2) {
        return date1.getFullYear() === date2.getFullYear() &&
            date1.getMonth() === date2.getMonth() &&
            date1.getDate() === date2.getDate();
    }

    // FIX: Get date string in YYYY-MM-DD format
    function getDateString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function showToast(message, duration = 3000) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    }

    // FIX: Completely rewritten date range function with proper date handling
    function getDateRange(filter) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        let startDate, endDate;

        switch(filter) {
            case 'today':
                startDate = new Date(today);
                endDate = new Date(today);
                endDate.setDate(endDate.getDate() + 1);
                endDate.setMilliseconds(-1);
                break;
            case 'week':
                startDate = new Date(today);
                startDate.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 7);
                endDate.setMilliseconds(-1);
                break;
            case 'month':
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                endDate.setHours(23, 59, 59, 999);
                break;
            case 'all':
                startDate = new Date(2000, 0, 1); // Far past
                endDate = new Date(2100, 11, 31); // Far future
                break;
            case 'custom':
                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                if (start && end) {
                    startDate = parseDate(start);
                    endDate = parseDate(end);
                    endDate.setHours(23, 59, 59, 999);
                } else {
                    startDate = new Date(2000, 0, 1);
                    endDate = new Date(2100, 11, 31);
                }
                break;
            default:
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                endDate.setHours(23, 59, 59, 999);
        }

        return { startDate, endDate };
    }

    // FIX: Improved filter function for expenses
    function filterExpensesByDateRange(expenses, filter) {
        const { startDate, endDate } = getDateRange(filter);

        return expenses.filter(e => {
            const expenseDate = parseDate(e.date);
            // Set to noon to avoid timezone edge cases
            expenseDate.setHours(12, 0, 0, 0);
            return expenseDate >= startDate && expenseDate <= endDate;
        });
    }

    // ==================== PAGE NAVIGATION ====================
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

        const page = document.getElementById(pageId);
        if (page) {
            page.classList.add('active');
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.page === pageId) {
                item.classList.add('active');
            }
        });

        // Load page data
        setTimeout(() => {
            switch(pageId) {
                case 'dashboardPage':
                    loadDashboard();
                    break;
                case 'transactionsPage':
                    loadTransactions();
                    break;
                case 'statsPage':
                    loadStats();
                    break;
                case 'friendsPage':
                    loadFriends();
                    break;
            }
        }, 50);
    }

    // ==================== MODAL MANAGEMENT ====================
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            if (modalId === 'addExpenseModal') {
                resetExpenseForm();
            }
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }
    }

    // ==================== TRANSACTION DETAIL VIEW ====================
    async function viewTransactionDetail(id) {
        const expense = await dbGet(STORES.expenses, id);
        if (!expense) return;

        currentViewingExpenseId = id;
        const cat = allCategories[expense.category] || expenseCategories.other;
        const isExpense = expense.type === 'expense';

        let splitInfo = '';
        if (expense.splits && expense.splits.length > 0) {
            const friends = await dbGetAll(STORES.friends);
            const friendTx = await dbGetAll(STORES.friendTransactions);

            splitInfo = '<div class="detail-row"><span class="detail-label"><span class="material-icons">group</span>Split With</span></div>';

            for (const split of expense.splits) {
                const friend = friends.find(f => f.id === split.friendId);
                const splitTx = friendTx.find(tx => tx.expenseId === id && tx.friendId === split.friendId && tx.isSplit);
                const settled = splitTx ? splitTx.settled : split.settled;

                splitInfo += `
                    <div class="detail-row" style="padding-left: 30px;">
                        <span class="detail-label">${friend ? friend.name : 'Unknown'}</span>
                        <span class="detail-value">
                            ${formatCurrency(split.amount)}
                            <span class="badge ${settled ? 'badge-success' : 'badge-warning'}" style="margin-left:5px;">
                                ${settled ? 'Settled' : 'Pending'}
                            </span>
                        </span>
                    </div>
                `;
            }
        }

        const content = `
            <div class="transaction-detail-header">
                <div class="transaction-detail-icon ${cat.class}">
                    <span class="material-icons">${cat.icon}</span>
                </div>
                <div class="transaction-detail-amount ${expense.type}">
                    ${isExpense ? '-' : '+'}${formatCurrency(expense.amount)}
                </div>
                <div class="transaction-detail-desc">${expense.description}</div>
            </div>

            <div class="transaction-detail-info">
                <div class="detail-row">
                    <span class="detail-label"><span class="material-icons">category</span>Category</span>
                    <span class="detail-value">${cat.label || expense.category}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label"><span class="material-icons">event</span>Date</span>
                    <span class="detail-value">${formatFullDate(expense.date)}</span>
                </div>
                ${expense.time ? `
                <div class="detail-row">
                    <span class="detail-label"><span class="material-icons">schedule</span>Time</span>
                    <span class="detail-value">${formatTime(expense.time)}</span>
                </div>
                ` : ''}
                <div class="detail-row">
                    <span class="detail-label"><span class="material-icons">swap_vert</span>Type</span>
                    <span class="detail-value">
                        <span class="badge ${isExpense ? 'badge-danger' : 'badge-success'}">
                            ${isExpense ? 'Expense' : 'Income'}
                        </span>
                    </span>
                </div>
                ${expense.notes ? `
                <div class="detail-row">
                    <span class="detail-label"><span class="material-icons">notes</span>Notes</span>
                    <span class="detail-value">${expense.notes}</span>
                </div>
                ` : ''}
                ${splitInfo}
            </div>

            <div class="transaction-detail-actions">
                <button class="btn btn-primary" id="editTransactionBtn">
                    <span class="material-icons">edit</span>
                    Edit
                </button>
                <button class="btn btn-danger" id="deleteTransactionBtn">
                    <span class="material-icons">delete</span>
                    Delete
                </button>
            </div>
        `;

        document.getElementById('transactionDetailContent').innerHTML = content;
        openModal('transactionDetailModal');

        // Add event listeners
        document.getElementById('editTransactionBtn').addEventListener('click', () => {
            closeModal('transactionDetailModal');
            editExpense(currentViewingExpenseId);
        });

        document.getElementById('deleteTransactionBtn').addEventListener('click', () => {
            closeModal('transactionDetailModal');
            deleteExpense(currentViewingExpenseId);
        });
    }

    // ==================== SUMMARY CARD CLICK HANDLERS ====================
    async function showSummaryDetail(type) {
        const expenses = await dbGetAll(STORES.expenses);
        const filteredExpenses = filterExpensesByDateRange(expenses, currentFilter);

        let title = '';
        let content = '';

        switch(type) {
            case 'income':
                title = '<span class="material-icons">trending_up</span> Income Details';
                const incomeItems = filteredExpenses.filter(e => e.type === 'income');
                if (incomeItems.length === 0) {
                    content = '<div class="empty-state"><span class="material-icons">money_off</span><p>No income in this period</p></div>';
                } else {
                    content = incomeItems.sort((a, b) => new Date(b.date) - new Date(a.date)).map(e => `
                        <div class="summary-detail-item" data-expense-id="${e.id}">
                            <div>
                                <div style="font-weight:500;">${e.description}</div>
                                <div style="font-size:0.75rem;color:var(--gray-500);">${formatDate(e.date)}</div>
                            </div>
                            <span style="color:var(--secondary);font-weight:600;">+${formatCurrency(e.amount)}</span>
                        </div>
                    `).join('');
                }
                break;

            case 'expense':
                title = '<span class="material-icons">trending_down</span> Expense Details';
                const expenseItems = filteredExpenses.filter(e => e.type === 'expense');
                if (expenseItems.length === 0) {
                    content = '<div class="empty-state"><span class="material-icons">sentiment_satisfied</span><p>No expenses in this period</p></div>';
                } else {
                    content = expenseItems.sort((a, b) => new Date(b.date) - new Date(a.date)).map(e => `
                        <div class="summary-detail-item" data-expense-id="${e.id}">
                            <div>
                                <div style="font-weight:500;">${e.description}</div>
                                <div style="font-size:0.75rem;color:var(--gray-500);">${formatDate(e.date)}</div>
                            </div>
                            <span style="color:var(--danger);font-weight:600;">-${formatCurrency(e.amount)}</span>
                        </div>
                    `).join('');
                }
                break;

            case 'balance':
                title = '<span class="material-icons">account_balance</span> Balance Summary';
                const totalIncome = filteredExpenses.filter(e => e.type === 'income').reduce((sum, e) => sum + e.amount, 0);
                const totalExpense = filteredExpenses.filter(e => e.type === 'expense').reduce((sum, e) => sum + e.amount, 0);
                content = `
                    <div class="summary-detail-item">
                        <span style="color:var(--secondary);">Total Income</span>
                        <span style="color:var(--secondary);font-weight:600;">+${formatCurrency(totalIncome)}</span>
                    </div>
                    <div class="summary-detail-item">
                        <span style="color:var(--danger);">Total Expenses</span>
                        <span style="color:var(--danger);font-weight:600;">-${formatCurrency(totalExpense)}</span>
                    </div>
                    <div class="summary-detail-item" style="background:var(--gray-100);border-radius:8px;margin-top:10px;padding:15px;">
                        <span style="font-weight:600;">Net Balance</span>
                        <span style="font-weight:700;font-size:1.2rem;color:${totalIncome - totalExpense >= 0 ? 'var(--secondary)' : 'var(--danger)'};">
                            ${totalIncome - totalExpense >= 0 ? '+' : ''}${formatCurrency(totalIncome - totalExpense)}
                        </span>
                    </div>
                `;
                break;

            case 'pending':
                title = '<span class="material-icons">pending</span> Pending Amounts';
                const friendTx = await dbGetAll(STORES.friendTransactions);
                const friends = await dbGetAll(STORES.friends);

                let pendingContent = '';
                let hasItems = false;

                friends.forEach(friend => {
                    const friendTransactions = friendTx.filter(tx => tx.friendId === friend.id);
                    let balance = 0;
                    friendTransactions.forEach(tx => {
                        if (tx.type === 'give') balance += tx.amount;
                        else balance -= tx.amount;
                    });

                    if (balance !== 0) {
                        hasItems = true;
                        pendingContent += `
                            <div class="summary-detail-item" data-friend-id="${friend.id}">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    <div style="width:35px;height:35px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:600;">
                                        ${friend.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div style="font-weight:500;">${friend.name}</div>
                                        <div style="font-size:0.75rem;color:var(--gray-500);">
                                            ${balance > 0 ? 'owes you' : 'you owe'}
                                        </div>
                                    </div>
                                </div>
                                <span style="color:${balance > 0 ? 'var(--secondary)' : 'var(--danger)'};font-weight:600;">
                                    ${formatCurrency(balance)}
                                </span>
                            </div>
                        `;
                    }
                });

                content = hasItems ? pendingContent : '<div class="empty-state"><span class="material-icons">check_circle</span><p>No pending amounts!</p></div>';
                break;
        }

        document.getElementById('summaryDetailTitle').innerHTML = title;
        document.getElementById('summaryDetailList').innerHTML = content;
        openModal('summaryDetailModal');
    }

    // ==================== EXPENSE MANAGEMENT ====================
    function resetExpenseForm() {
        document.getElementById('expenseForm').reset();
        document.getElementById('transactionId').value = '';
        document.getElementById('transactionType').value = 'expense';
        document.getElementById('expenseModalTitle').innerHTML = '<span class="material-icons">add_circle</span> Add Transaction';

        const now = new Date();
        document.getElementById('expenseDate').value = getDateString(now);
        document.getElementById('expenseTime').value = now.toTimeString().slice(0, 5);

        document.querySelectorAll('#categoryGrid .category-option').forEach(opt => opt.classList.remove('selected'));
        const foodOption = document.querySelector('#categoryGrid .category-option[data-category="food"]');
        if (foodOption) foodOption.classList.add('selected');

        document.querySelectorAll('#incomeCategoryGrid .category-option').forEach(opt => opt.classList.remove('selected'));
        const salaryOption = document.querySelector('#incomeCategoryGrid .category-option[data-category="salary"]');
        if (salaryOption) salaryOption.classList.add('selected');

        document.querySelectorAll('#transactionTypeTabs .tab').forEach(tab => tab.classList.remove('active'));
        const expenseTab = document.querySelector('#transactionTypeTabs .tab[data-type="expense"]');
        if (expenseTab) expenseTab.classList.add('active');

        document.getElementById('expenseCategorySection').style.display = 'block';
        document.getElementById('incomeCategorySection').style.display = 'none';
        document.getElementById('splitSection').style.display = 'block';

        document.getElementById('splitToggle').classList.remove('active');
        document.getElementById('splitDetails').style.display = 'none';
        document.getElementById('splitItems').innerHTML = '';
        document.getElementById('splitWarning').classList.remove('show');

        // Reset save button
        const saveBtn = document.getElementById('saveExpenseBtn');
        saveBtn.disabled = false;
        isSaving = false;
    }

    function switchTransactionType(type) {
        document.getElementById('transactionType').value = type;

        document.querySelectorAll('#transactionTypeTabs .tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.type === type);
        });

        document.getElementById('expenseCategorySection').style.display = type === 'expense' ? 'block' : 'none';
        document.getElementById('incomeCategorySection').style.display = type === 'income' ? 'block' : 'none';
        document.getElementById('splitSection').style.display = type === 'expense' ? 'block' : 'none';
    }

    function toggleSplit() {
        const toggle = document.getElementById('splitToggle');
        const details = document.getElementById('splitDetails');
        toggle.classList.toggle('active');
        details.style.display = toggle.classList.contains('active') ? 'block' : 'none';

        if (toggle.classList.contains('active') && document.getElementById('splitItems').children.length === 0) {
            addSplitItem();
        }
    }

    async function addSplitItem() {
        const friends = await dbGetAll(STORES.friends);
        const splitItems = document.getElementById('splitItems');

        if (friends.length === 0) {
            showToast('Add friends first to split expenses');
            return;
        }

        const itemId = generateId();
        const div = document.createElement('div');
        div.className = 'split-item';
        div.id = `split-${itemId}`;

        let friendOptions = '<option value="">Select friend</option>';
        friends.forEach(f => {
            friendOptions += `<option value="${f.id}">${f.name}</option>`;
        });

        div.innerHTML = `
            <select class="split-friend">${friendOptions}</select>
            <input type="number" class="split-amount" placeholder="Amount" step="0.01" inputmode="decimal">
            <button type="button" class="icon-btn" data-split-id="${itemId}" aria-label="Remove">
                <span class="material-icons">close</span>
            </button>
        `;

        splitItems.appendChild(div);

        // Add listener to validate split amounts
        div.querySelector('.split-amount').addEventListener('input', validateSplitAmounts);
    }

    function removeSplitItem(itemId) {
        const item = document.getElementById(`split-${itemId}`);
        if (item) {
            item.remove();
            validateSplitAmounts();
        }
    }

    // FIX: Validate split amounts don't exceed total
    function validateSplitAmounts() {
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const splitItems = document.querySelectorAll('.split-item');
        let totalSplit = 0;

        splitItems.forEach(item => {
            const splitAmount = parseFloat(item.querySelector('.split-amount').value) || 0;
            totalSplit += splitAmount;
        });

        const warning = document.getElementById('splitWarning');
        if (totalSplit > amount && amount > 0) {
            warning.classList.add('show');
            warning.textContent = `Split total (${formatCurrency(totalSplit)}) exceeds expense (${formatCurrency(amount)})!`;
        } else {
            warning.classList.remove('show');
        }

        return totalSplit <= amount || amount === 0;
    }

    async function saveExpense() {
        // FIX: Prevent double-clicks
        if (isSaving) return;

        const amount = parseFloat(document.getElementById('amount').value);
        const description = document.getElementById('description').value.trim();
        const date = document.getElementById('expenseDate').value;
        const time = document.getElementById('expenseTime').value;
        const notes = document.getElementById('notes').value.trim();
        const type = document.getElementById('transactionType').value;
        const id = document.getElementById('transactionId').value || generateId();

        let category;
        if (type === 'expense') {
            const selected = document.querySelector('#categoryGrid .category-option.selected');
            category = selected ? selected.dataset.category : 'other';
        } else {
            const selected = document.querySelector('#incomeCategoryGrid .category-option.selected');
            category = selected ? selected.dataset.category : 'income-other';
        }

        // FIX: Better validation
        if (!amount || amount <= 0) {
            showToast('Please enter a valid amount');
            return;
        }

        if (!description) {
            showToast('Please enter a description');
            return;
        }

        // FIX: Validate split amounts
        const splitToggle = document.getElementById('splitToggle');
        if (type === 'expense' && splitToggle.classList.contains('active')) {
            if (!validateSplitAmounts()) {
                showToast('Split amounts cannot exceed total expense');
                return;
            }
        }

        isSaving = true;
        const saveBtn = document.getElementById('saveExpenseBtn');
        saveBtn.disabled = true;
        showActionLoading();

        try {
            const expense = {
                id,
                amount,
                description,
                category,
                date,
                time,
                notes,
                type,
                createdAt: new Date().toISOString()
            };

            if (type === 'expense' && splitToggle.classList.contains('active')) {
                const splitItems = document.querySelectorAll('.split-item');
                const splits = [];

                for (const item of splitItems) {
                    const friendId = item.querySelector('.split-friend').value;
                    const splitAmount = parseFloat(item.querySelector('.split-amount').value);

                    if (friendId && splitAmount && splitAmount > 0) {
                        splits.push({ friendId, amount: splitAmount, settled: false });

                        await dbAdd(STORES.friendTransactions, {
                            id: generateId(),
                            friendId,
                            amount: splitAmount,
                            type: 'give',
                            description: `Split: ${description}`,
                            date: date,
                            expenseId: id,
                            isSplit: true,
                            settled: false,
                            createdAt: new Date().toISOString()
                        });
                    }
                }

                expense.splits = splits;
            }

            await dbPut(STORES.expenses, expense);

            hideActionLoading();
            closeModal('addExpenseModal');
            showToast(document.getElementById('transactionId').value ? 'Transaction updated!' : 'Transaction added!');

            // Refresh current page
            const activePage = document.querySelector('.page.active');
            if (activePage) {
                showPage(activePage.id);
            }
        } catch (error) {
            hideActionLoading();
            showToast('Error saving transaction: ' + error.message);
        } finally {
            isSaving = false;
            saveBtn.disabled = false;
        }
    }

    async function editExpense(id) {
        const expense = await dbGet(STORES.expenses, id);
        if (!expense) return;

        document.getElementById('transactionId').value = expense.id;
        document.getElementById('amount').value = expense.amount;
        document.getElementById('description').value = expense.description;
        document.getElementById('expenseDate').value = expense.date;
        document.getElementById('expenseTime').value = expense.time || '';
        document.getElementById('notes').value = expense.notes || '';
        document.getElementById('transactionType').value = expense.type;
        document.getElementById('expenseModalTitle').innerHTML = '<span class="material-icons">edit</span> Edit Transaction';

        switchTransactionType(expense.type);

        if (expense.type === 'expense') {
            document.querySelectorAll('#categoryGrid .category-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.category === expense.category);
            });
        } else {
            document.querySelectorAll('#incomeCategoryGrid .category-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.category === expense.category);
            });
        }

        openModal('addExpenseModal');
    }

    async function deleteExpense(id) {
        showConfirmDialog('Delete Transaction', 'Are you sure you want to delete this transaction?', async () => {
            showActionLoading();
            try {
                const expense = await dbGet(STORES.expenses, id);
                if (expense && expense.splits) {
                    const friendTx = await dbGetAll(STORES.friendTransactions);
                    const relatedTx = friendTx.filter(tx => tx.expenseId === id);
                    for (const tx of relatedTx) {
                        await dbDelete(STORES.friendTransactions, tx.id);
                    }
                }

                await dbDelete(STORES.expenses, id);
                hideActionLoading();
                showToast('Transaction deleted!');

                const activePage = document.querySelector('.page.active');
                if (activePage) {
                    showPage(activePage.id);
                }
            } catch (error) {
                hideActionLoading();
                showToast('Error deleting transaction: ' + error.message);
            }
        });
    }

    function showConfirmDialog(title, message, callback) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        confirmCallback = callback;
        document.getElementById('confirmDialog').classList.add('show');
    }

    // ==================== DASHBOARD ====================
    async function loadDashboard() {
        const expenses = await dbGetAll(STORES.expenses);
        const filteredExpenses = filterExpensesByDateRange(expenses, currentFilter);

        let totalIncome = 0;
        let totalExpense = 0;

        filteredExpenses.forEach(e => {
            if (e.type === 'income') {
                totalIncome += e.amount;
            } else {
                totalExpense += e.amount;
            }
        });

        document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
        document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
        document.getElementById('totalBalance').textContent = formatCurrency(totalIncome - totalExpense);

        // Update filter info banner
        document.getElementById('filterPeriodText').textContent = filterLabels[currentFilter] || 'Selected Period';
        document.getElementById('filterCount').textContent = `${filteredExpenses.length} transaction${filteredExpenses.length !== 1 ? 's' : ''}`;

        await updatePendingAmount();

        // FIX: Load recent transactions independently of filter
        await loadRecentTransactions();

        updateExpenseChart(filteredExpenses);
    }

    async function updatePendingAmount() {
        const friendTx = await dbGetAll(STORES.friendTransactions);
        const friends = await dbGetAll(STORES.friends);

        let totalOwedToYou = 0;
        let totalYouOwe = 0;

        friends.forEach(friend => {
            const friendTransactions = friendTx.filter(tx => tx.friendId === friend.id);
            let balance = 0;

            friendTransactions.forEach(tx => {
                if (tx.type === 'give') {
                    balance += tx.amount;
                } else {
                    balance -= tx.amount;
                }
            });

            if (balance > 0) {
                totalOwedToYou += balance;
            } else {
                totalYouOwe += Math.abs(balance);
            }
        });

        const netPending = totalOwedToYou - totalYouOwe;
        document.getElementById('pendingAmount').textContent = formatCurrency(netPending);
    }

    // FIX: Recent transactions now loads ALL recent, regardless of filter
    async function loadRecentTransactions() {
        const container = document.getElementById('recentTransactions');
        const allExpenses = await dbGetAll(STORES.expenses);

        const sorted = [...allExpenses].sort((a, b) => {
            const dateA = new Date(a.date + 'T' + (a.time || '23:59'));
            const dateB = new Date(b.date + 'T' + (b.time || '23:59'));
            return dateB - dateA;
        }).slice(0, 5);

        if (sorted.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <span class="material-icons">receipt_long</span>
                    <h3>No transactions yet</h3>
                    <p>Add your first expense to get started</p>
                </div>
            `;
            return;
        }

        container.innerHTML = sorted.map(expense => createExpenseItem(expense)).join('');
    }

    function createExpenseItem(expense) {
        const cat = allCategories[expense.category] || expenseCategories.other;
        const isExpense = expense.type === 'expense';
        const hasSplits = expense.splits && expense.splits.length > 0;
        const pendingSplits = hasSplits ? expense.splits.filter(s => !s.settled).length : 0;

        return `
            <li class="expense-item" data-expense-id="${expense.id}" data-action="view">
                <div class="expense-icon ${cat.class}">
                    <span class="material-icons">${cat.icon}</span>
                </div>
                <div class="expense-details">
                    <div class="expense-title">
                        ${expense.description}
                        ${pendingSplits > 0 ? `<span class="split-badge"><span class="material-icons" style="font-size:10px;">group</span> ${pendingSplits} pending</span>` : ''}
                    </div>
                    <div class="expense-meta">
                        <span><span class="material-icons">event</span>${formatDate(expense.date)}</span>
                        ${expense.time ? `<span><span class="material-icons">schedule</span>${formatTime(expense.time)}</span>` : ''}
                    </div>
                </div>
                <div class="expense-amount ${expense.type}">
                    ${isExpense ? '-' : '+'}${formatCurrency(expense.amount)}
                </div>
            </li>
        `;
    }

    function updateExpenseChart(expenses) {
        const container = document.getElementById('expenseChartContainer');

        // FIX: Check if Chart.js is available
        if (!chartsAvailable) {
            container.innerHTML = `
                <div class="chart-fallback">
                    <span class="material-icons">pie_chart</span>
                    <p>Charts unavailable</p>
                    <small>Check your internet connection</small>
                </div>
            `;
            return;
        }

        const categoryTotals = {};

        expenses.filter(e => e.type === 'expense').forEach(e => {
            categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
        });

        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);
        const colors = labels.map(label => allCategories[label]?.color || '#718096');

        // Ensure canvas exists
        if (!document.getElementById('expenseChart')) {
            container.innerHTML = '<canvas id="expenseChart"></canvas>';
        }

        const ctx = document.getElementById('expenseChart').getContext('2d');

        if (expenseChart) {
            expenseChart.destroy();
        }

        if (data.length === 0) {
            container.innerHTML = `
                <div class="chart-fallback">
                    <span class="material-icons">pie_chart</span>
                    <p>No expense data to display</p>
                </div>
            `;
            return;
        }

        expenseChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels.map(l => (l.charAt(0).toUpperCase() + l.slice(1)).replace('-', ' ')),
                datasets: [{
                    data,
                    backgroundColor: colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: { size: 11 }
                        }
                    }
                }
            }
        });
    }

    // ==================== TRANSACTIONS PAGE ====================
    async function loadTransactions() {
        const expenses = await dbGetAll(STORES.expenses);
        const filteredExpenses = filterExpensesByDateRange(expenses, currentTransactionsFilter);

        displayGroupedTransactions(filteredExpenses);
    }

    function displayGroupedTransactions(expenses) {
        const container = document.getElementById('transactionsList');

        if (expenses.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <span class="material-icons">receipt_long</span>
                    <h3>No transactions found</h3>
                    <p>Try changing the filter or add a new expense</p>
                </div>
            `;
            return;
        }

        const grouped = {};
        expenses.forEach(e => {
            if (!grouped[e.date]) {
                grouped[e.date] = [];
            }
            grouped[e.date].push(e);
        });

        const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

        let html = '';
        sortedDates.forEach(date => {
            const dayExpenses = grouped[date].sort((a, b) => {
                const timeA = a.time || '00:00';
                const timeB = b.time || '00:00';
                return timeB.localeCompare(timeA);
            });

            let dayIncome = 0;
            let dayExpense = 0;
            dayExpenses.forEach(e => {
                if (e.type === 'income') {
                    dayIncome += e.amount;
                } else {
                    dayExpense += e.amount;
                }
            });
            const dayNet = dayIncome - dayExpense;

            html += `
                <div class="date-group">
                    <div class="date-header">
                        <span>${formatDate(date)}</span>
                        <span class="date-total ${dayNet >= 0 ? 'positive' : ''}">${dayNet >= 0 ? '+' : '-'}${formatCurrency(Math.abs(dayNet))}</span>
                    </div>
                    <ul class="expense-list">
                        ${dayExpenses.map(e => createExpenseItem(e)).join('')}
                    </ul>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    async function filterTransactions() {
        const searchTerm = document.getElementById('searchTransactions').value.toLowerCase();

        const expenses = await dbGetAll(STORES.expenses);
        let filtered = filterExpensesByDateRange(expenses, currentTransactionsFilter);

        if (searchTerm) {
            filtered = filtered.filter(e =>
                e.description.toLowerCase().includes(searchTerm) ||
                e.category.toLowerCase().includes(searchTerm) ||
                (e.notes && e.notes.toLowerCase().includes(searchTerm))
            );
        }

        displayGroupedTransactions(filtered);
    }

    // ==================== STATS PAGE ====================
    async function loadStats() {
        const expenses = await dbGetAll(STORES.expenses);

        const expenseOnly = expenses.filter(e => e.type === 'expense');
        const totalTransactions = expenses.length;

        const uniqueDays = new Set(expenseOnly.map(e => e.date)).size;
        const avgPerDay = uniqueDays > 0 ? expenseOnly.reduce((sum, e) => sum + e.amount, 0) / uniqueDays : 0;

        const categoryTotals = {};
        expenseOnly.forEach(e => {
            categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
        });
        const topCategory = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];

        document.getElementById('statTotalTransactions').textContent = totalTransactions;
        document.getElementById('statAvgExpense').textContent = formatCurrency(avgPerDay);
        document.getElementById('statTopCategory').textContent = topCategory ? (topCategory[0].charAt(0).toUpperCase() + topCategory[0].slice(1)).replace('-', ' ') : '-';

        updateMonthlyChart(expenses);
        updateCategoryChart(expenseOnly);
    }

    function updateMonthlyChart(expenses) {
        const container = document.getElementById('monthlyChartContainer');

        if (!chartsAvailable) {
            container.innerHTML = `
                <div class="chart-fallback">
                    <span class="material-icons">bar_chart</span>
                    <p>Charts unavailable</p>
                </div>
            `;
            return;
        }

        const monthlyData = {};
        const now = new Date();

        for (let i = 5; i >= 0; i--) {
            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const key = date.toLocaleDateString('en-US', { month: 'short' });
            monthlyData[key] = { income: 0, expense: 0 };
        }

        expenses.forEach(e => {
            const date = parseDate(e.date);
            const key = date.toLocaleDateString('en-US', { month: 'short' });

            if (monthlyData[key]) {
                if (e.type === 'income') {
                    monthlyData[key].income += e.amount;
                } else {
                    monthlyData[key].expense += e.amount;
                }
            }
        });

        const labels = Object.keys(monthlyData);
        const incomeData = labels.map(l => monthlyData[l].income);
        const expenseData = labels.map(l => monthlyData[l].expense);

        if (!document.getElementById('monthlyChart')) {
            container.innerHTML = '<canvas id="monthlyChart"></canvas>';
        }

        const ctx = document.getElementById('monthlyChart').getContext('2d');

        if (monthlyChart) {
            monthlyChart.destroy();
        }

        monthlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Income',
                        data: incomeData,
                        backgroundColor: '#48bb78'
                    },
                    {
                        label: 'Expense',
                        data: expenseData,
                        backgroundColor: '#f56565'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }

    function updateCategoryChart(expenses) {
        const container = document.getElementById('categoryChartContainer');

        if (!chartsAvailable) {
            container.innerHTML = `
                <div class="chart-fallback">
                    <span class="material-icons">donut_large</span>
                    <p>Charts unavailable</p>
                </div>
            `;
            return;
        }

        const categoryTotals = {};

        expenses.forEach(e => {
            categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
        });

        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);
        const colors = labels.map(label => allCategories[label]?.color || '#718096');

        if (!document.getElementById('categoryChart')) {
            container.innerHTML = '<canvas id="categoryChart"></canvas>';
        }

        const ctx = document.getElementById('categoryChart').getContext('2d');

        if (categoryChart) {
            categoryChart.destroy();
        }

        if (data.length === 0) {
            container.innerHTML = `
                <div class="chart-fallback">
                    <span class="material-icons">donut_large</span>
                    <p>No data to display</p>
                </div>
            `;
            return;
        }

        categoryChart = new Chart(ctx, {
            type: 'polarArea',
            data: {
                labels: labels.map(l => (l.charAt(0).toUpperCase() + l.slice(1)).replace('-', ' ')),
                datasets: [{
                    data,
                    backgroundColor: colors.map(c => c + '80'),
                    borderColor: colors,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: { size: 10 }
                        }
                    }
                }
            }
        });
    }

    // ==================== FRIENDS MANAGEMENT ====================
    async function loadFriends() {
        const friends = await dbGetAll(STORES.friends);
        const friendTx = await dbGetAll(STORES.friendTransactions);
        allFriendsData = friends;

        displayFriends(friends, friendTx);
    }

    function displayFriends(friends, friendTx) {
        const container = document.getElementById('friendsList');

        if (friends.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <span class="material-icons">groups</span>
                    <h3>No friends added yet</h3>
                    <p>Add friends to split expenses with them</p>
                </div>
            `;
            updateSettleSummary(0, 0);
            return;
        }

        let totalOwedToYou = 0;
        let totalYouOwe = 0;

        let html = '';
        friends.forEach(friend => {
            const friendTransactions = friendTx.filter(tx => tx.friendId === friend.id);
            let balance = 0;
            let pendingSplitCount = 0;

            friendTransactions.forEach(tx => {
                if (tx.type === 'give') {
                    balance += tx.amount;
                } else {
                    balance -= tx.amount;
                }
                if (tx.isSplit && !tx.settled) {
                    pendingSplitCount++;
                }
            });

            if (balance > 0) {
                totalOwedToYou += balance;
            } else {
                totalYouOwe += Math.abs(balance);
            }

            const balanceClass = balance > 0 ? 'positive' : balance < 0 ? 'negative' : '';
            const balanceLabel = balance > 0 ? 'owes you' : balance < 0 ? 'you owe' : 'settled up';

            html += `
                <div class="friend-card" data-friend-id="${friend.id}">
                    <div class="friend-header">
                        <div class="friend-avatar">${friend.name.charAt(0).toUpperCase()}</div>
                        <div class="friend-info">
                            <h3>
                                ${friend.name}
                                ${pendingSplitCount > 0 ? `
                                    <span class="friend-split-indicator">
                                        <span class="material-icons">call_split</span>
                                        ${pendingSplitCount}
                                    </span>
                                ` : ''}
                            </h3>
                            <p>${friend.phone || 'No phone'}</p>
                        </div>
                    </div>
                    <div class="friend-balance">
                        <div class="amount ${balanceClass}">${balance >= 0 ? '' : '-'}${formatCurrency(balance)}</div>
                        <div class="label">${balanceLabel}</div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
        updateSettleSummary(totalOwedToYou, totalYouOwe);
    }

    async function filterFriends() {
        const searchTerm = document.getElementById('searchFriends').value.toLowerCase();
        const friendTx = await dbGetAll(STORES.friendTransactions);

        let filtered = allFriendsData;

        if (searchTerm) {
            filtered = allFriendsData.filter(f =>
                f.name.toLowerCase().includes(searchTerm) ||
                (f.phone && f.phone.includes(searchTerm))
            );
        }

        displayFriends(filtered, friendTx);
    }

    function updateSettleSummary(owedToYou, youOwe) {
        const net = owedToYou - youOwe;
        const summary = document.getElementById('settleSummary');

        if (net > 0) {
            summary.innerHTML = `
                <h3>You'll get back ${formatCurrency(net)}</h3>
                <p>Overall, friends owe you money</p>
            `;
            summary.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
        } else if (net < 0) {
            summary.innerHTML = `
                <h3>You owe ${formatCurrency(net)}</h3>
                <p>Overall, you owe money to friends</p>
            `;
            summary.style.background = 'linear-gradient(135deg, #f56565, #e53e3e)';
        } else {
            summary.innerHTML = `
                <h3>All settled up!</h3>
                <p>No pending balances with friends</p>
            `;
            summary.style.background = 'linear-gradient(135deg, #667eea, #5a67d8)';
        }
    }

    function openAddFriendModal() {
        document.getElementById('friendForm').reset();
        document.getElementById('friendId').value = '';
        document.getElementById('friendModalTitle').innerHTML = '<span class="material-icons">person_add</span> Add Friend';
        openModal('addFriendModal');
    }

    async function saveFriend() {
        const name = document.getElementById('friendName').value.trim();
        const phone = document.getElementById('friendPhone').value.trim();
        const notes = document.getElementById('friendNotes').value.trim();
        const id = document.getElementById('friendId').value || generateId();

        if (!name) {
            showToast('Please enter a name');
            return;
        }

        showActionLoading();

        try {
            await dbPut(STORES.friends, {
                id,
                name,
                phone,
                notes,
                createdAt: new Date().toISOString()
            });

            hideActionLoading();
            closeModal('addFriendModal');
            document.getElementById('friendForm').reset();
            document.getElementById('friendId').value = '';
            showToast('Friend saved!');
            loadFriends();
        } catch (error) {
            hideActionLoading();
            showToast('Error saving friend: ' + error.message);
        }
    }

    async function openFriendDetail(friendId) {
        currentFriendId = friendId;
        const friend = await dbGet(STORES.friends, friendId);
        if (!friend) return;

        document.getElementById('friendDetailName').innerHTML = `
            <span class="material-icons">person</span>
            ${friend.name}
        `;
        document.getElementById('friendGiveName').textContent = friend.name;
        document.getElementById('friendReceiveName').textContent = friend.name;

        await updateFriendBalance(friendId);
        await loadPendingSplits(friendId);

        document.getElementById('giveAmount').value = '';
        document.getElementById('giveDescription').value = '';
        document.getElementById('receiveAmount').value = '';
        document.getElementById('receiveDescription').value = '';

        showFriendAction('give');
        openModal('friendDetailModal');
    }

    async function updateFriendBalance(friendId) {
        const friendTx = await dbGetAll(STORES.friendTransactions);
        const transactions = friendTx.filter(tx => tx.friendId === friendId);

        let balance = 0;
        transactions.forEach(tx => {
            if (tx.type === 'give') {
                balance += tx.amount;
            } else {
                balance -= tx.amount;
            }
        });

        const balanceEl = document.getElementById('friendDetailBalance');
        const balanceClass = balance > 0 ? 'positive' : balance < 0 ? 'negative' : '';
        const label = balance > 0 ? 'owes you' : balance < 0 ? 'you owe' : 'settled up';

        balanceEl.innerHTML = `
            <div class="amount ${balanceClass}">${balance >= 0 ? '' : '-'}${formatCurrency(balance)}</div>
            <div class="label">${label}</div>
        `;

        await loadFriendHistory(friendId);
    }

    async function loadPendingSplits(friendId) {
        const friendTx = await dbGetAll(STORES.friendTransactions);
        const pendingSplits = friendTx.filter(tx =>
            tx.friendId === friendId &&
            tx.isSplit &&
            !tx.settled
        );

        pendingSplitsForFriend = pendingSplits;

        const section = document.getElementById('pendingSplitsSection');
        const list = document.getElementById('pendingSplitsList');

        if (pendingSplits.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        list.innerHTML = pendingSplits.map(split => `
            <div class="pending-split-item">
                <div class="pending-split-info">
                    <div class="pending-split-desc">${split.description}</div>
                    <div class="pending-split-date">${formatDate(split.date)}</div>
                </div>
                <span class="pending-split-amount">${formatCurrency(split.amount)}</span>
                <button class="btn btn-sm btn-success" data-settle-split="${split.id}">
                    Settle
                </button>
            </div>
        `).join('');
    }

    async function settleSplitDirectly(splitId) {
        showActionLoading();

        try {
            const friendTx = await dbGetAll(STORES.friendTransactions);
            const split = friendTx.find(tx => tx.id === splitId);

            if (!split) {
                hideActionLoading();
                return;
            }

            split.settled = true;
            await dbPut(STORES.friendTransactions, split);

            await dbAdd(STORES.friendTransactions, {
                id: generateId(),
                friendId: split.friendId,
                amount: split.amount,
                type: 'receive',
                description: `Settled: ${split.description}`,
                date: getDateString(new Date()),
                settledSplitId: split.id,
                createdAt: new Date().toISOString()
            });

            if (split.expenseId) {
                const expense = await dbGet(STORES.expenses, split.expenseId);
                if (expense && expense.splits) {
                    const allSplits = await dbGetAll(STORES.friendTransactions);
                    const expenseSplits = allSplits.filter(tx => tx.expenseId === split.expenseId && tx.isSplit);
                    const allSettled = expenseSplits.every(s => s.settled);

                    if (allSettled) {
                        const totalSplitAmount = expenseSplits.reduce((sum, s) => sum + s.amount, 0);
                        const newAmount = expense.amount - totalSplitAmount;

                        if (newAmount > 0 && newAmount !== expense.amount) {
                            hideActionLoading();
                            showUpdateTransactionDialog(expense, newAmount);
                            return;
                        }
                    }
                }
            }

            hideActionLoading();
            showToast('Split settled!');
            await updateFriendBalance(currentFriendId);
            await loadPendingSplits(currentFriendId);
            await loadFriends();
            await updatePendingAmount();
        } catch (error) {
            hideActionLoading();
            showToast('Error settling split: ' + error.message);
        }
    }

    function showUpdateTransactionDialog(expense, newAmount) {
        document.getElementById('updateTransactionMessage').innerHTML = `
            All splits for "<strong>${expense.description}</strong>" are now settled.<br><br>
            Original amount: <strong>${formatCurrency(expense.amount)}</strong><br>
            Your share: <strong>${formatCurrency(newAmount)}</strong><br><br>
            Would you like to update the transaction to reflect your actual expense?
        `;

        updateTransactionCallback = async (shouldUpdate) => {
            if (shouldUpdate) {
                expense.amount = newAmount;
                expense.originalAmount = expense.amount;
                await dbPut(STORES.expenses, expense);
                showToast('Transaction updated!');
                loadDashboard();
            }
            await updateFriendBalance(currentFriendId);
            await loadPendingSplits(currentFriendId);
            await loadFriends();
            await updatePendingAmount();
        };

        document.getElementById('updateTransactionDialog').classList.add('show');
    }

    function closeUpdateTransactionDialog(shouldUpdate) {
        document.getElementById('updateTransactionDialog').classList.remove('show');
        if (updateTransactionCallback) {
            updateTransactionCallback(shouldUpdate);
            updateTransactionCallback = null;
        }
    }

    async function loadFriendHistory(friendId) {
        const friendTx = await dbGetAll(STORES.friendTransactions);
        const transactions = friendTx
            .filter(tx => tx.friendId === friendId)
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        const container = document.getElementById('friendTransactionHistory');

        if (transactions.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 20px;">No transactions yet</p>';
            return;
        }

        container.innerHTML = transactions.map(tx => `
            <div class="history-item">
                <div class="history-item-info">
                    <div class="history-item-title">${tx.description || (tx.type === 'give' ? 'You gave' : 'You received')}</div>
                    <div class="history-item-meta">
                        <span class="history-item-date">${formatDate(tx.date || tx.createdAt.split('T')[0])}</span>
                        ${tx.isSplit ? `<span class="badge badge-warning"><span class="material-icons">call_split</span>Split</span>` : ''}
                        ${tx.settled ? `<span class="badge badge-success"><span class="material-icons">check</span>Settled</span>` : ''}
                    </div>
                </div>
                <div class="history-item-amount">
                    <span class="badge ${tx.type === 'give' ? 'badge-danger' : 'badge-success'}">
                        ${tx.type === 'give' ? '-' : '+'}${formatCurrency(tx.amount)}
                    </span>
                </div>
                <div class="history-item-actions">
                    <button class="icon-btn" data-delete-friend-tx="${tx.id}" title="Delete" aria-label="Delete transaction">
                        <span class="material-icons" style="font-size:18px;">delete</span>
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function deleteFriendTransaction(txId) {
        showConfirmDialog('Delete Transaction', 'Delete this transaction?', async () => {
            showActionLoading();
            try {
                await dbDelete(STORES.friendTransactions, txId);
                hideActionLoading();
                showToast('Transaction deleted!');
                await updateFriendBalance(currentFriendId);
                await loadPendingSplits(currentFriendId);
                await loadFriends();
                await updatePendingAmount();
            } catch (error) {
                hideActionLoading();
                showToast('Error deleting: ' + error.message);
            }
        });
    }

    function showFriendAction(action) {
        document.querySelectorAll('.friend-action-section').forEach(s => s.style.display = 'none');

        const sectionId = `friendAction${action.charAt(0).toUpperCase() + action.slice(1)}`;
        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = 'block';
        }

        document.querySelectorAll('#friendActionTabs .tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.action === action) {
                tab.classList.add('active');
            }
        });
    }

    async function recordFriendTransaction(type) {
        const amount = parseFloat(document.getElementById(`${type}Amount`).value);
        const description = document.getElementById(`${type}Description`).value.trim();

        if (!amount || amount <= 0) {
            showToast('Please enter a valid amount');
            return;
        }

        if (type === 'receive' && pendingSplitsForFriend.length > 0) {
            const matchingSplit = pendingSplitsForFriend.find(s => Math.abs(s.amount - amount) < 0.01);

            if (matchingSplit) {
                document.getElementById('matchingSplitItem').innerHTML = `
                    <div class="pending-split-info">
                        <div class="pending-split-desc">${matchingSplit.description}</div>
                        <div class="pending-split-date">${formatDate(matchingSplit.date)}</div>
                    </div>
                    <span class="pending-split-amount">${formatCurrency(matchingSplit.amount)}</span>
                `;

                settleSplitCallback = async (shouldSettle) => {
                    if (shouldSettle) {
                        await settleSplitDirectly(matchingSplit.id);
                    } else {
                        await addFriendTransaction(type, amount, description);
                    }
                };

                document.getElementById('settleSplitDialog').classList.add('show');
                return;
            }
        }

        await addFriendTransaction(type, amount, description);
    }

    async function addFriendTransaction(type, amount, description) {
        showActionLoading();

        try {
            await dbAdd(STORES.friendTransactions, {
                id: generateId(),
                friendId: currentFriendId,
                amount,
                type,
                description: description || (type === 'give' ? 'Payment given' : 'Payment received'),
                date: getDateString(new Date()),
                createdAt: new Date().toISOString()
            });

            document.getElementById(`${type}Amount`).value = '';
            document.getElementById(`${type}Description`).value = '';

            hideActionLoading();
            showToast('Transaction recorded!');
            await updateFriendBalance(currentFriendId);
            await loadPendingSplits(currentFriendId);
            await loadFriends();
            await updatePendingAmount();
        } catch (error) {
            hideActionLoading();
            showToast('Error recording transaction: ' + error.message);
        }
    }

    function closeSettleSplitDialog(shouldSettle) {
        document.getElementById('settleSplitDialog').classList.remove('show');
        if (settleSplitCallback) {
            settleSplitCallback(shouldSettle);
            settleSplitCallback = null;
        }
    }

    async function settleUp() {
        showConfirmDialog('Settle Up', 'Mark all transactions as settled? This will zero out the balance.', async () => {
            showActionLoading();

            try {
                const friendTx = await dbGetAll(STORES.friendTransactions);
                const transactions = friendTx.filter(tx => tx.friendId === currentFriendId);

                let balance = 0;
                transactions.forEach(tx => {
                    if (tx.type === 'give') {
                        balance += tx.amount;
                    } else {
                        balance -= tx.amount;
                    }
                });

                if (balance !== 0) {
                    await dbAdd(STORES.friendTransactions, {
                        id: generateId(),
                        friendId: currentFriendId,
                        amount: Math.abs(balance),
                        type: balance > 0 ? 'receive' : 'give',
                        description: 'Settled up',
                        date: getDateString(new Date()),
                        isSettlement: true,
                        createdAt: new Date().toISOString()
                    });

                    for (const tx of transactions) {
                        if (tx.isSplit && !tx.settled) {
                            tx.settled = true;
                            await dbPut(STORES.friendTransactions, tx);
                        }
                    }
                }

                hideActionLoading();
                showToast('Settled up!');
                await updateFriendBalance(currentFriendId);
                await loadPendingSplits(currentFriendId);
                await loadFriends();
                await updatePendingAmount();
            } catch (error) {
                hideActionLoading();
                showToast('Error settling: ' + error.message);
            }
        });
    }

    async function editCurrentFriend() {
        const friend = await dbGet(STORES.friends, currentFriendId);
        if (!friend) return;

        document.getElementById('friendId').value = friend.id;
        document.getElementById('friendName').value = friend.name;
        document.getElementById('friendPhone').value = friend.phone || '';
        document.getElementById('friendNotes').value = friend.notes || '';
        document.getElementById('friendModalTitle').innerHTML = '<span class="material-icons">edit</span> Edit Friend';

        closeModal('friendDetailModal');
        openModal('addFriendModal');
    }

    async function deleteFriend() {
        showConfirmDialog('Delete Friend', 'Delete this friend and all their transactions?', async () => {
            showActionLoading();

            try {
                const friendTx = await dbGetAll(STORES.friendTransactions);
                const transactions = friendTx.filter(tx => tx.friendId === currentFriendId);
                for (const tx of transactions) {
                    await dbDelete(STORES.friendTransactions, tx.id);
                }

                await dbDelete(STORES.friends, currentFriendId);

                hideActionLoading();
                showToast('Friend deleted!');
                closeModal('friendDetailModal');
                loadFriends();
                updatePendingAmount();
            } catch (error) {
                hideActionLoading();
                showToast('Error deleting friend: ' + error.message);
            }
        });
    }

    // ==================== SETTINGS ====================
    function loadSettings() {
        const settings = JSON.parse(localStorage.getItem('settings') || '{}');
        document.getElementById('currencySymbol').value = settings.currency || 'â‚¹';
        document.getElementById('monthlyBudget').value = settings.budget || '';
    }

    function saveSettings() {
        const settings = {
            currency: document.getElementById('currencySymbol').value,
            budget: parseFloat(document.getElementById('monthlyBudget').value) || 0
        };
        localStorage.setItem('settings', JSON.stringify(settings));
        closeModal('settingsModal');
        showToast('Settings saved!');
        loadDashboard();
    }

    async function exportData() {
        showActionLoading();

        try {
            const data = {
                expenses: await dbGetAll(STORES.expenses),
                friends: await dbGetAll(STORES.friends),
                friendTransactions: await dbGetAll(STORES.friendTransactions),
                settings: JSON.parse(localStorage.getItem('settings') || '{}'),
                exportDate: new Date().toISOString(),
                version: '2.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expense-manager-backup-${getDateString(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            hideActionLoading();
            showToast('Data exported!');
        } catch (error) {
            hideActionLoading();
            showToast('Error exporting: ' + error.message);
        }
    }

    async function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        showActionLoading();

        try {
            const text = await file.text();
            const data = JSON.parse(text);

            // FIX: Validate imported data structure
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid backup file format');
            }

            if (data.expenses && Array.isArray(data.expenses)) {
                await dbClear(STORES.expenses);
                for (const expense of data.expenses) {
                    if (expense.id && expense.amount && expense.description) {
                        await dbAdd(STORES.expenses, expense);
                    }
                }
            }

            if (data.friends && Array.isArray(data.friends)) {
                await dbClear(STORES.friends);
                for (const friend of data.friends) {
                    if (friend.id && friend.name) {
                        await dbAdd(STORES.friends, friend);
                    }
                }
            }

            if (data.friendTransactions && Array.isArray(data.friendTransactions)) {
                await dbClear(STORES.friendTransactions);
                for (const tx of data.friendTransactions) {
                    if (tx.id && tx.friendId && tx.amount) {
                        await dbAdd(STORES.friendTransactions, tx);
                    }
                }
            }

            if (data.settings && typeof data.settings === 'object') {
                localStorage.setItem('settings', JSON.stringify(data.settings));
            }

            hideActionLoading();
            showToast('Data imported successfully!');
            loadDashboard();
            loadSettings();
        } catch (error) {
            hideActionLoading();
            showToast('Error importing data: ' + error.message);
        }

        event.target.value = '';
    }

    async function clearAllData() {
        showConfirmDialog('Clear All Data', 'Are you sure you want to delete ALL data? This cannot be undone!', async () => {
            showActionLoading();

            try {
                await dbClear(STORES.expenses);
                await dbClear(STORES.friends);
                await dbClear(STORES.friendTransactions);
                localStorage.removeItem('settings');

                hideActionLoading();
                showToast('All data cleared!');
                loadDashboard();
                loadFriends();
                loadSettings();
            } catch (error) {
                hideActionLoading();
                showToast('Error clearing data: ' + error.message);
            }
        });
    }

    function applyDateRange() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
            showToast('Please select both dates');
            return;
        }

        if (new Date(startDate) > new Date(endDate)) {
            showToast('Start date must be before end date');
            return;
        }

        currentFilter = 'custom';
        loadDashboard();
    }

    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
        // Bottom Navigation
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const pageId = this.dataset.page;
                if (pageId) {
                    showPage(pageId);
                }
            });
        });

        // Add Expense Button
        document.getElementById('addExpenseBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            openModal('addExpenseModal');
        });

        // Settings Button
        document.getElementById('settingsBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            openModal('settingsModal');
        });

        // View All Transactions Button
        document.getElementById('viewAllTransactionsBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showPage('transactionsPage');
        });

        // Add Friend Button
        document.getElementById('addFriendBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            openAddFriendModal();
        });

        // Apply Date Range Button
        document.getElementById('applyDateRangeBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            applyDateRange();
        });

        // Summary Card Clicks
        document.getElementById('incomeCard').addEventListener('click', () => showSummaryDetail('income'));
        document.getElementById('expenseCard').addEventListener('click', () => showSummaryDetail('expense'));
        document.getElementById('balanceCard').addEventListener('click', () => showSummaryDetail('balance'));
        document.getElementById('pendingCard').addEventListener('click', () => showSummaryDetail('pending'));

        // Modal Close Buttons
        document.getElementById('closeExpenseModal').addEventListener('click', () => closeModal('addExpenseModal'));
        document.getElementById('cancelExpenseBtn').addEventListener('click', () => closeModal('addExpenseModal'));
        document.getElementById('closeFriendModal').addEventListener('click', () => closeModal('addFriendModal'));
        document.getElementById('cancelFriendBtn').addEventListener('click', () => closeModal('addFriendModal'));
        document.getElementById('closeFriendDetailModal').addEventListener('click', () => closeModal('friendDetailModal'));
        document.getElementById('closeSettingsModal').addEventListener('click', () => closeModal('settingsModal'));
        document.getElementById('closeTransactionDetailModal').addEventListener('click', () => closeModal('transactionDetailModal'));
        document.getElementById('closeSummaryDetailModal').addEventListener('click', () => closeModal('summaryDetailModal'));
        document.getElementById('summaryDetailCloseBtn').addEventListener('click', () => closeModal('summaryDetailModal'));

        // Save Buttons
        document.getElementById('saveExpenseBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            saveExpense();
        });

        document.getElementById('saveFriendBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            saveFriend();
        });

        document.getElementById('saveSettingsBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            saveSettings();
        });

        // Transaction Type Tabs
        document.getElementById('transactionTypeTabs').addEventListener('click', function(e) {
            const tab = e.target.closest('.tab');
            if (tab && tab.dataset.type) {
                switchTransactionType(tab.dataset.type);
            }
        });

        // Category Grid - Expense
        document.getElementById('categoryGrid').addEventListener('click', function(e) {
            const option = e.target.closest('.category-option');
            if (option) {
                document.querySelectorAll('#categoryGrid .category-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            }
        });

        // Category Grid - Income
        document.getElementById('incomeCategoryGrid').addEventListener('click', function(e) {
            const option = e.target.closest('.category-option');
            if (option) {
                document.querySelectorAll('#incomeCategoryGrid .category-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            }
        });

        // Split Toggle
        document.getElementById('splitToggle').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleSplit();
        });

        // Add Split Item Button
        document.getElementById('addSplitItemBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            addSplitItem();
        });

        // Split Items - Remove Button
        document.getElementById('splitItems').addEventListener('click', function(e) {
            const btn = e.target.closest('.icon-btn[data-split-id]');
            if (btn) {
                e.preventDefault();
                e.stopPropagation();
                removeSplitItem(btn.dataset.splitId);
            }
        });

        // Amount input change - validate splits
        document.getElementById('amount').addEventListener('input', validateSplitAmounts);

        // Dashboard Filter Tabs
        document.getElementById('dashboardFilterTabs').addEventListener('click', function(e) {
            const tab = e.target.closest('.filter-tab');
            if (!tab) return;

            const filter = tab.dataset.filter;

            document.querySelectorAll('#dashboardFilterTabs .filter-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            currentFilter = filter;

            const datePicker = document.getElementById('dateRangePicker');
            datePicker.classList.toggle('show', filter === 'custom');

            if (filter !== 'custom') {
                loadDashboard();
            }
        });

        // Transactions Filter Tabs
        document.getElementById('transactionsFilterTabs').addEventListener('click', function(e) {
            const tab = e.target.closest('.filter-tab');
            if (!tab) return;

            const filter = tab.dataset.filter;

            document.querySelectorAll('#transactionsFilterTabs .filter-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            currentTransactionsFilter = filter;
            loadTransactions();
        });

        // FIX: Search Transactions with debounce
        document.getElementById('searchTransactions').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterTransactions, 300);
        });

        // FIX: Search Friends with debounce
        document.getElementById('searchFriends').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterFriends, 300);
        });

        // Recent Transactions - Click to View Detail
        document.getElementById('recentTransactions').addEventListener('click', function(e) {
            const expenseItem = e.target.closest('.expense-item[data-expense-id]');
            if (expenseItem) {
                e.preventDefault();
                e.stopPropagation();
                viewTransactionDetail(expenseItem.dataset.expenseId);
            }
        });

        // Transactions List - Click to View Detail
        document.getElementById('transactionsList').addEventListener('click', function(e) {
            const expenseItem = e.target.closest('.expense-item[data-expense-id]');
            if (expenseItem) {
                e.preventDefault();
                e.stopPropagation();
                viewTransactionDetail(expenseItem.dataset.expenseId);
            }
        });

        // Summary Detail List - Click to View Transaction or Friend
        document.getElementById('summaryDetailList').addEventListener('click', function(e) {
            const expenseItem = e.target.closest('[data-expense-id]');
            if (expenseItem) {
                closeModal('summaryDetailModal');
                viewTransactionDetail(expenseItem.dataset.expenseId);
                return;
            }

            const friendItem = e.target.closest('[data-friend-id]');
            if (friendItem) {
                closeModal('summaryDetailModal');
                openFriendDetail(friendItem.dataset.friendId);
            }
        });

        // Friends List - Click to Open Detail
        document.getElementById('friendsList').addEventListener('click', function(e) {
            const friendCard = e.target.closest('.friend-card[data-friend-id]');
            if (friendCard) {
                e.preventDefault();
                e.stopPropagation();
                openFriendDetail(friendCard.dataset.friendId);
            }
        });

        // Friend Action Tabs
        document.getElementById('friendActionTabs').addEventListener('click', function(e) {
            const tab = e.target.closest('.tab');
            if (tab && tab.dataset.action) {
                showFriendAction(tab.dataset.action);
            }
        });

        // Record Give Button
        document.getElementById('recordGiveBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            recordFriendTransaction('give');
        });

        // Record Receive Button
        document.getElementById('recordReceiveBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            recordFriendTransaction('receive');
        });

        // Edit Friend Button
        document.getElementById('editFriendBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            editCurrentFriend();
        });

        // Delete Friend Button
        document.getElementById('deleteFriendBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            deleteFriend();
        });

        // Settle Up Button
        document.getElementById('settleUpBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            settleUp();
        });

        // Pending Splits List - Settle Button
        document.getElementById('pendingSplitsList').addEventListener('click', function(e) {
            const settleBtn = e.target.closest('[data-settle-split]');
            if (settleBtn) {
                e.preventDefault();
                e.stopPropagation();
                settleSplitDirectly(settleBtn.dataset.settleSplit);
            }
        });

        // Friend Transaction History - Delete Button
        document.getElementById('friendTransactionHistory').addEventListener('click', function(e) {
            const deleteBtn = e.target.closest('[data-delete-friend-tx]');
            if (deleteBtn) {
                e.preventDefault();
                e.stopPropagation();
                deleteFriendTransaction(deleteBtn.dataset.deleteFriendTx);
            }
        });

        // Settings Data Management Buttons
        document.getElementById('exportDataBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            exportData();
        });

        document.getElementById('importDataBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('importFile').click();
        });

        document.getElementById('importFile').addEventListener('change', importData);

        document.getElementById('clearAllDataBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            clearAllData();
        });

        // Confirm Dialog Buttons
        document.getElementById('confirmCancelBtn').addEventListener('click', function() {
            document.getElementById('confirmDialog').classList.remove('show');
            confirmCallback = null;
        });

        document.getElementById('confirmYesBtn').addEventListener('click', function() {
            if (confirmCallback) {
                confirmCallback();
            }
            document.getElementById('confirmDialog').classList.remove('show');
            confirmCallback = null;
        });

        // Settle Split Dialog Buttons
        document.getElementById('settleSplitNewBtn').addEventListener('click', function() {
            closeSettleSplitDialog(false);
        });

        document.getElementById('settleSplitYesBtn').addEventListener('click', function() {
            closeSettleSplitDialog(true);
        });

        // Update Transaction Dialog Buttons
        document.getElementById('updateTransactionNoBtn').addEventListener('click', function() {
            closeUpdateTransactionDialog(false);
        });

        document.getElementById('updateTransactionYesBtn').addEventListener('click', function() {
            closeUpdateTransactionDialog(true);
        });

        // Modal Overlay Click to Close
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
        });

        // FIX: ESC key to close modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close any open modal
                document.querySelectorAll('.modal-overlay.show').forEach(modal => {
                    modal.classList.remove('show');
                });
                document.querySelectorAll('.confirm-dialog.show').forEach(dialog => {
                    dialog.classList.remove('show');
                });
                document.body.style.overflow = '';
            }
        });

        // Prevent form submission
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
        });

        document.getElementById('friendForm').addEventListener('submit', function(e) {
            e.preventDefault();
        });
    }

    // ==================== INITIALIZATION ====================
    async function init() {
        showLoading();

        try {
            await initDB();
            loadSettings();
            setupEventListeners();
            await loadDashboard();

            // Set default date range for custom filter
            const today = new Date();
            const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('startDate').value = getDateString(firstOfMonth);
            document.getElementById('endDate').value = getDateString(today);

            // Delay hiding to show smooth animation
            setTimeout(() => {
                hideLoading();
            }, 500);
        } catch (error) {
            console.error('Failed to initialize:', error);
            hideLoading();
            showToast('Error initializing app: ' + error.message);
        }
    }

    // Initialize on load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Handle back button for modals
    window.addEventListener('popstate', function() {
        document.querySelectorAll('.modal-overlay.show').forEach(modal => {
            modal.classList.remove('show');
        });
        document.querySelectorAll('.confirm-dialog.show').forEach(dialog => {
            dialog.classList.remove('show');
        });
        document.body.style.overflow = '';
    });
</script>
</body>
</html>
